<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ù„ÙˆØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#020617;
  --panel:#0f172a;
  --card:#111827;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --success:#22c55e;
  --shadow:0 10px 30px rgba(0,0,0,.35);
}

*{box-sizing:border-box;font-family:system-ui,Tahoma}

body{
  margin:0;
  background:#020617;
  color:var(--text);
  padding:24px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:24px;
}

.header h1{
  margin:0;
  font-size:26px;
  color:var(--accent);
}

.header span{
  color:var(--muted);
  font-size:13px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:16px;
}

.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px;
  box-shadow:var(--shadow);
}

.card h2{
  margin:0 0 10px;
  font-size:14px;
  color:var(--muted);
}

.big{
  font-size:48px;
  font-weight:800;
  color:var(--success);
}

.small{
  font-size:34px;
  font-weight:700;
}

.section{
  margin-top:28px;
}

.section h3{
  margin:0 0 12px;
  font-size:16px;
  color:#c7d2fe;
}

.list{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
}

.row{
  display:flex;
  justify-content:space-between;
  padding:14px 18px;
  border-bottom:1px solid var(--border);
}

.row:last-child{border-bottom:none}

.row strong{
  color:var(--accent);
}
</style>
</head>

<body>

<div class="header">
  <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h1>
  <span id="updated">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: â€”</span>
</div>

<div class="grid">
  <div class="card">
    <h2>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©</h2>
    <div class="big" id="total">â€”</div>
  </div>

  <div class="card">
    <h2>Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h2>
    <div class="small" id="today">â€”</div>
  </div>

  <div class="card">
    <h2>Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h2>
    <div class="small" id="week">â€”</div>
  </div>
</div>

<div class="section">
  <h3>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h3>
  <div class="list" id="clinicList"></div>
</div>

<div class="section">
  <h3>ğŸ“ˆ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</h3>
  <div class="grid">
    <div class="card">
      <h2>Ø­Ø³Ø¨ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h2>
      <canvas id="clinicChart" height="160"></canvas>
    </div>
    <div class="card">
      <h2>Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</h2>
      <canvas id="daysChart" height="160"></canvas>
    </div>
  </div>
</div>

<script>
const API_URL = '/api/admin/stats/bookings';
let clinicChart, daysChart;

async function loadStats(){
  try{
    const token =
      localStorage.getItem('admin_token') ||
      prompt('Ø§Ø¯Ø®Ù„ ØªÙˆÙƒÙ† Ø§Ù„Ø£Ø¯Ù…Ù†');

  const pin =
  localStorage.getItem('admin_pin') ||
  prompt('Ø§Ø¯Ø®Ù„ PIN Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');

if (!pin) return;

const res = await fetch(
  API_URL + '?pin=' + encodeURIComponent(pin)
);

localStorage.setItem('admin_pin', pin);


    if(!res.ok){
      alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ©');
      return;
    }

    localStorage.setItem('admin_token',token);

    const data = await res.json();

    document.getElementById('total').textContent = data.total ?? 0;
    document.getElementById('today').textContent = data.today ?? 0;
    document.getElementById('week').textContent  = data.week ?? 0;
    document.getElementById('updated').textContent =
      'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: '+new Date().toLocaleTimeString('ar-SA');

    // list
    const list = document.getElementById('clinicList');
    list.innerHTML = '';
    Object.entries(data.byClinic || {}).forEach(([n,c])=>{
      list.innerHTML += `
        <div class="row">
          <span>${n}</span>
          <strong>${c}</strong>
        </div>`;
    });

    // chart by clinic
    if(clinicChart) clinicChart.destroy();
    clinicChart = new Chart(document.getElementById('clinicChart'),{
      type:'bar',
      data:{
        labels:Object.keys(data.byClinic||{}),
        datasets:[{
          data:Object.values(data.byClinic||{}),
          backgroundColor:'#38bdf8'
        }]
      },
      options:{plugins:{legend:{display:false}}}
    });

    // last 7 days (Ù…Ù† today - week ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶)
    const days = ['-6','-5','-4','-3','-2','-1','Ø§Ù„ÙŠÙˆÙ…'];
    const vals = Array(6).fill(0).concat([data.today||0]);

    if(daysChart) daysChart.destroy();
    daysChart = new Chart(document.getElementById('daysChart'),{
      type:'line',
      data:{
        labels:days,
        datasets:[{
          data:vals,
          borderColor:'#22c55e',
          fill:false,
          tension:.4
        }]
      },
      options:{plugins:{legend:{display:false}}}
    });

  }catch(e){
    console.error(e);
    alert('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
  }
}

loadStats();
</script>

</body>
</html>
